name: TypeScript SonarQube SAST Analysis

on:
  push:
    branches: [ main, develop, feat/* ]
    paths:
      - 'apis/typescript-vulnerabilities/**'
  pull_request:
    branches: [ main, develop, feat/* ]
    paths:
      - 'apis/typescript-vulnerabilities/**'
  workflow_dispatch:

jobs:
  sonarqube:
    name: SonarQube SAST Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: apis/typescript-vulnerabilities/package-lock.json
    
    - name: Cache SonarQube packages
      uses: actions/cache@v4
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar

    - name: Install dependencies
      run: |
        cd apis/typescript-vulnerabilities
        npm ci

    - name: Build TypeScript project
      run: |
        cd apis/typescript-vulnerabilities
        npm run build

    - name: Install sonar-scanner
      run: |
        npm install -g sonar-scanner

    - name: Run SonarQube scan
      run: |
        cd apis/typescript-vulnerabilities
        sonar-scanner \
          -Dsonar.projectKey=typescript-vulnerabilities \
          -Dsonar.projectName="TypeScript Vulnerabilities Example" \
          -Dsonar.projectVersion=1.0.0 \
          -Dsonar.sources=src \
          -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
          -Dsonar.typescript.tsconfigPath=tsconfig.json \
          -Dsonar.sourceEncoding=UTF-8 \
          -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/*.min.js \
          -Dsonar.inclusions=**/*.ts,**/*.js

    - name: Upload SonarQube report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sonarqube-report-typescript
        path: |
          apis/typescript-vulnerabilities/.scannerwork/
        retention-days: 30

    - name: Run security audit
      run: |
        cd apis/typescript-vulnerabilities
        npm audit --audit-level=moderate
      continue-on-error: true
